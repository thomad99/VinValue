<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VIN Value</title>
    <style>
      body { 
        font-family: system-ui, Arial, sans-serif; 
        margin: 0; 
        padding: 24px; 
        color: #e2e8f0; 
        min-height: 100vh;
        background: linear-gradient(120deg, #334155, #374151, #475569);
        background-size: 400% 400%;
        background-attachment: fixed;
        animation: gradientShift 45s ease infinite;
      }
      body.working {
        background: linear-gradient(120deg, #3b82f6, #8b5cf6, #ef4444, #10b981);
        background-size: 400% 400%;
        background-attachment: fixed;
        animation: gradientShiftActive 2s ease-in-out infinite;
        filter: saturate(1.3) brightness(1.1);
      }
      @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }
      @keyframes gradientShiftActive {
        0% { background-position: 0% 50%; }
        25% { background-position: 100% 0%; }
        50% { background-position: 100% 100%; }
        75% { background-position: 0% 100%; }
        100% { background-position: 0% 50%; }
      }
      /* Respect reduced motion */
      @media (prefers-reduced-motion: reduce) {
        body { animation: none; }
      }
      .container { max-width: 680px; margin: 0 auto; }
      h1 { margin: 0 0 16px; font-size: 28px; }
      form { display: grid; gap: 12px; background: #111827; padding: 16px; border-radius: 8px; border: 1px solid #1f2937; }
      label { display: block; font-size: 14px; color: #cbd5e1; margin-bottom: 4px; }
      input { width: 100%; padding: 10px 12px; border-radius: 6px; border: 1px solid #374151; background: #0b1020; color: #e5e7eb; box-sizing: border-box; }
      button { padding: 10px 14px; border-radius: 6px; border: 1px solid #334155; background: #2563eb; color: white; cursor: pointer; font-weight: 600; }
      button:disabled { opacity: 0.6; cursor: not-allowed; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: start; }
      .vin-row { display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: end; }
      .result { margin-top: 16px; padding: 12px; border-radius: 8px; border: 1px solid #1f2937; background: #0b1020; }
      .muted { color: #94a3b8; font-size: 13px; }
      a { color: #93c5fd; }
      .logo { display: block; margin: 8px auto 8px; max-width: 100%; height: auto; object-fit: contain; filter: drop-shadow(0 2px 8px rgba(0,0,0,0.35)); }
    </style>
  </head>
  <body>
    <div class="container">
      <img src="lab007-trans.PNG" alt="Lab007" class="logo" />
      <form id="valueForm">
        <div>
          <label for="vin">VIN</label>
          <div class="vin-row">
            <input id="vin" name="vin" placeholder="Enter VIN" required />
            <button id="scanVin" type="button" title="Scan image using camera">Scan Image</button>
          </div>
          <input id="vinImage" type="file" accept="image/*" capture="environment" style="display:none" />
        </div>
        <div class="row">
          <div>
            <label for="mileage">Mileage</label>
            <input id="mileage" name="mileage" type="number" placeholder="e.g. 45000" required />
          </div>
          <div>
            <label for="zip">Zip Code</label>
            <input id="zip" name="zip" placeholder="defaults to server env WEBUYZIPCODE" />
          </div>
        </div>
        <div>
          <label for="email">Email</label>
          <input id="email" name="email" type="email" placeholder="defaults to server env WEBUYEMAIL" />
        </div>
        <button id="submit" type="submit">Get Valuation</button>
      </form>
      <div id="scanResult" style="display:none; margin-top: 20px; padding: 16px; background: #1f2937; border-radius: 8px; border: 1px solid #374151; color: #cbd5e1;">
        <div id="scanResultContent"></div>
      </div>
      <div id="result" class="result" hidden>
        <div id="price" style="font-size: 40px; font-weight: 800; text-align: center;"></div>
        <div id="details" style="margin-top: 12px;">
          <button id="toggleDetails" type="button" style="background: #374151; border: 1px solid #4b5563; color: #d1d5db; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Show Details</button>
          <div id="detailsContent" style="display: none; margin-top: 8px;">
            <div id="progress" class="muted" style="white-space: pre-line;"></div>
            <div id="shots" style="margin-top:8px"></div>
          </div>
        </div>
        <div id="error" style="color: #fca5a5"></div>
      </div>
    </div>

    <script>
      const form = document.getElementById('valueForm');
      const result = document.getElementById('result');
      const price = document.getElementById('price');
      const error = document.getElementById('error');
      const progress = document.getElementById('progress');
      const shots = document.getElementById('shots');
      const submit = document.getElementById('submit');
      const scanVinBtn = document.getElementById('scanVin');
      const vinInput = document.getElementById('vin');
      const vinImage = document.getElementById('vinImage');
      const zipInput = document.getElementById('zip');
      const emailInput = document.getElementById('email');
      const toggleDetails = document.getElementById('toggleDetails');
      const detailsContent = document.getElementById('detailsContent');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        result.hidden = true;
        price.textContent = '';
        error.textContent = '';
        submit.disabled = true;
        submit.textContent = 'Working…';
        document.body.classList.add('working');
        // Hide details and reset toggle button
        detailsContent.style.display = 'none';
        toggleDetails.textContent = 'Show Details';
        
        // Hide scan result when starting valuation
        const scanResult = document.getElementById('scanResult');
        if (scanResult) scanResult.style.display = 'none';
        try {
          const payload = {
            vin: document.getElementById('vin').value.trim(),
            mileage: document.getElementById('mileage').value.trim(),
            zip: document.getElementById('zip').value.trim(),
            email: document.getElementById('email').value.trim(),
          };
          
          // Add detected car details if no VIN but we have make/model/year
          if (!payload.vin && window.detectedCarDetails) {
            payload.make = window.detectedCarDetails.make;
            payload.model = window.detectedCarDetails.model;
            payload.year = window.detectedCarDetails.year;
          }
          // Show progress updates
          const progressSteps = [
            'Starting valuation process...',
            'Navigating to website...',
            payload.vin ? 'Entering VIN number...' : 'Using Make & Model lookup...',
            payload.vin ? 'Waiting for page load...' : 'Selecting year...',
            payload.vin ? 'Entering mileage...' : 'Selecting make...',
            payload.vin ? 'Entering ZIP code...' : 'Selecting model...',
            payload.vin ? 'Entering email address...' : 'Entering mileage...',
            payload.vin ? 'Clicking Get Valuation...' : 'Entering ZIP code...',
            payload.vin ? 'Waiting for valuation result...' : 'Entering email address...',
            'Clicking Get Valuation...',
            'Waiting for valuation result...'
          ];
          
          let stepIndex = 0;
          const progressInterval = setInterval(() => {
            if (stepIndex < progressSteps.length) {
              progress.textContent = progressSteps[stepIndex];
              stepIndex++;
            }
          }, 2000);
          
          const res = await fetch('/api/value', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          
          clearInterval(progressInterval);
          progress.textContent = 'Processing valuation result...';
          const data = await res.json();
          result.hidden = false;
          
          if (!res.ok) {
            // Server returned an error with debug info
            error.textContent = data.error || 'Failed';
            if (data.steps) {
              progress.textContent = data.steps.join('\n');
            }
            if (data.screenshots) {
              shots.innerHTML = '';
              const links = [];
              if (data.screenshots.error) links.push(`<a href="${data.screenshots.error}" target="_blank">Error state</a>`);
              if (data.screenshots.filled) links.push(`<a href="${data.screenshots.filled}" target="_blank">Filled form</a>`);
              if (links.length) shots.innerHTML = 'Screenshots: ' + links.join(' · ');
            }
            return;
          }
          
          // Success case
          price.textContent = data.valuation;
          progress.textContent = (data.steps || []).join('\n');
          
          // Show dropdown selections if any
          if (data.selections && data.selections.length > 0) {
            const selectionsDiv = document.createElement('div');
            selectionsDiv.style.cssText = 'margin-top: 8px; padding: 8px; background: #1f2937; border-radius: 4px; font-size: 14px;';
            selectionsDiv.innerHTML = `<strong>Vehicle Options Selected:</strong><br>${data.selections.join('<br>')}`;
            progress.parentNode.insertBefore(selectionsDiv, progress.nextSibling);
          }
          
          // Show toggle button if there are details to show
          if (data.steps && data.steps.length > 0) {
            toggleDetails.style.display = 'inline-block';
          }
          
          shots.innerHTML = '';
          if (data.screenshots) {
            const links = [];
            if (data.screenshots.filled) links.push(`<a href="${data.screenshots.filled}" target="_blank">Filled form</a>`);
            if (data.screenshots.result) links.push(`<a href="${data.screenshots.result}" target="_blank">Valuation</a>`);
            if (links.length) shots.innerHTML = 'Screenshots: ' + links.join(' · ');
          }
        } catch (err) {
          result.hidden = false;
          error.textContent = err.message || 'Network error - check console';
          console.error('Request failed:', err);
        } finally {
          submit.disabled = false;
          submit.textContent = 'Get Valuation';
          document.body.classList.remove('working');
        }
      });

      // VIN scan logic
      const VIN_REGEX = /\b([A-HJ-NPR-Z\d]{17})\b/g; // excludes I, O, Q
      const YEAR_REGEX = /\b(19|20)\d{2}\b/g;
      const MILEAGE_REGEX = /\b(\d{1,3}(?:,\d{3})*)\s*(?:miles?|mi\.?)\b/gi;

      scanVinBtn?.addEventListener('click', () => {
        vinImage.click();
      });

      vinImage?.addEventListener('change', async () => {
        if (!vinImage.files || vinImage.files.length === 0) return;
        const file = vinImage.files[0];
        
        // Check file size (warn if over 5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert('Large image detected. It will be compressed automatically.');
        }
        
        try {
          scanVinBtn.disabled = true;
          scanVinBtn.textContent = 'Compressing image…';
          const dataUrl = await compressImage(file);
          scanVinBtn.textContent = 'Analyzing…';
          
          // Use OpenAI Vision API instead of Tesseract
          const response = await fetch('/api/analyze-image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ imageDataUrl: dataUrl })
          });
          
          if (!response.ok) {
            throw new Error('AI analysis failed');
          }
          
          const result = await response.json();
          
          // Handle VIN found - use VIN path
          if (result.vin) {
            vinInput.value = result.vin;
            showScanResult(`VIN detected: ${result.vin}`, 'vin');
            return;
          }
          
          // Handle car details found - use Make & Model path
          const details = [];
          if (result.make && result.model) details.push(`Make/Model: ${result.make} ${result.model}`);
          if (result.year) details.push(`Year: ${result.year}`);
          if (result.mileage) details.push(`Mileage: ${result.mileage}`);
          
          if (details.length > 0) {
            // Auto-fill the form with detected details
            vinInput.value = ''; // Clear VIN since we don't have one
            if (result.mileage) {
              document.getElementById('mileage').value = result.mileage.replace(/[^\d]/g, '');
            }
            
            // Store detected details for Make & Model path
            window.detectedCarDetails = {
              make: result.make || '',
              model: result.model || '',
              year: result.year || ''
            };
            
            showScanResult(`Car details detected:<br>${details.join('<br>')}<br><br>Proceeding with Make & Model lookup...`, 'details');
            
            // Automatically proceed with valuation after a short delay
            setTimeout(() => {
              document.getElementById('valueForm').dispatchEvent(new Event('submit'));
            }, 2000);
          } else {
            showScanResult('No VIN or car details detected. Try a clearer photo of the VIN label or car listing.', 'error');
          }
        } catch (e) {
          showScanResult('AI analysis failed: ' + (e && e.message ? e.message : 'unknown error'), 'error');
        } finally {
          scanVinBtn.disabled = false;
          scanVinBtn.textContent = 'Scan Image';
          vinImage.value = '';
        }
      });

      function fileToDataUrl(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      function compressImage(file, maxWidth = 1024, quality = 0.8) {
        return new Promise((resolve) => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const img = new Image();
          
          img.onload = () => {
            // Calculate new dimensions
            let { width, height } = img;
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // Draw and compress
            ctx.drawImage(img, 0, 0, width, height);
            const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
            resolve(compressedDataUrl);
          };
          
          img.src = URL.createObjectURL(file);
        });
      }

      function showScanResult(message, type = 'info') {
        const scanResult = document.getElementById('scanResult');
        const scanResultContent = document.getElementById('scanResultContent');
        
        // Set color based on type
        let borderColor = '#374151';
        if (type === 'vin') borderColor = '#10b981';
        else if (type === 'details') borderColor = '#3b82f6';
        else if (type === 'error') borderColor = '#ef4444';
        
        scanResult.style.borderColor = borderColor;
        scanResultContent.innerHTML = message;
        scanResult.style.display = 'block';
        
        // Hide after 5 seconds for non-error messages
        if (type !== 'error') {
          setTimeout(() => {
            scanResult.style.display = 'none';
          }, 5000);
        }
      }

      // Toggle details visibility
      toggleDetails?.addEventListener('click', () => {
        if (detailsContent.style.display === 'none') {
          detailsContent.style.display = 'block';
          toggleDetails.textContent = 'Hide Details';
        } else {
          detailsContent.style.display = 'none';
          toggleDetails.textContent = 'Show Details';
        }
      });

      // Prefill defaults from server environment
      (async () => {
        try {
          const res = await fetch('/api/defaults');
          if (!res.ok) return;
          const { zip, email } = await res.json();
          if (zip && !zipInput.value) zipInput.value = String(zip);
          if (email && !emailInput.value) emailInput.value = email;
        } catch (_) {}
      })();
    </script>
  </body>
  </html>


