<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VIN Value</title>
    <style>
      body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 24px; color: #e2e8f0; }
      /* Calming animated gradient background */
      body {
        background: linear-gradient(120deg, #0f172a, #0b1020, #0e1b4d);
        background-size: 400% 400%;
        animation: gradientShift 45s ease infinite;
      }
      @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }
      /* Respect reduced motion */
      @media (prefers-reduced-motion: reduce) {
        body { animation: none; }
      }
      .container { max-width: 680px; margin: 0 auto; }
      h1 { margin: 0 0 16px; font-size: 28px; }
      form { display: grid; gap: 12px; background: #111827; padding: 16px; border-radius: 8px; border: 1px solid #1f2937; }
      label { display: block; font-size: 14px; color: #cbd5e1; }
      input { width: 100%; padding: 10px 12px; border-radius: 6px; border: 1px solid #374151; background: #0b1020; color: #e5e7eb; }
      button { padding: 10px 14px; border-radius: 6px; border: 1px solid #334155; background: #2563eb; color: white; cursor: pointer; font-weight: 600; }
      button:disabled { opacity: 0.6; cursor: not-allowed; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .result { margin-top: 16px; padding: 12px; border-radius: 8px; border: 1px solid #1f2937; background: #0b1020; }
      .muted { color: #94a3b8; font-size: 13px; }
      a { color: #93c5fd; }
      .logo { display: block; margin: 8px auto 20px; height: 56px; object-fit: contain; filter: drop-shadow(0 2px 8px rgba(0,0,0,0.35)); }
    </style>
  </head>
  <body>
    <div class="container">
      <img src="/lab007-trans.png" alt="Lab007" class="logo" onerror="this.style.display='none'" />
      <h1>VIN Value</h1>
      <p class="muted">Fetch valuation from <a href="https://www.webuyanycarusa.com/?r=1" target="_blank" rel="noreferrer">webuyanycarusa.com</a>. Your inputs are sent to your local server only.</p>
      <form id="valueForm">
        <div>
          <label for="vin">VIN</label>
          <div class="row" style="grid-template-columns: 1fr auto; align-items: end;">
            <input id="vin" name="vin" placeholder="Enter VIN" required />
            <button id="scanVin" type="button" title="Scan VIN using camera">Scan VIN</button>
          </div>
          <input id="vinImage" type="file" accept="image/*" capture="environment" style="display:none" />
        </div>
        <div class="row">
          <div>
            <label for="mileage">Mileage</label>
            <input id="mileage" name="mileage" type="number" placeholder="e.g. 45000" required />
          </div>
          <div>
            <label for="zip">Zip Code</label>
            <input id="zip" name="zip" placeholder="defaults to server env WEBUYZIPCODE" />
          </div>
        </div>
        <div>
          <label for="email">Email</label>
          <input id="email" name="email" type="email" placeholder="defaults to server env WEBUYEMAIL" />
        </div>
        <button id="submit" type="submit">Get Valuation</button>
      </form>
      <div id="result" class="result" hidden>
        <div id="price" style="font-size: 20px; font-weight: 700;"></div>
        <div id="error" style="color: #fca5a5"></div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script>
      const form = document.getElementById('valueForm');
      const result = document.getElementById('result');
      const price = document.getElementById('price');
      const error = document.getElementById('error');
      const submit = document.getElementById('submit');
      const scanVinBtn = document.getElementById('scanVin');
      const vinInput = document.getElementById('vin');
      const vinImage = document.getElementById('vinImage');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        result.hidden = true;
        price.textContent = '';
        error.textContent = '';
        submit.disabled = true;
        submit.textContent = 'Working…';
        try {
          const payload = {
            vin: document.getElementById('vin').value.trim(),
            mileage: document.getElementById('mileage').value.trim(),
            zip: document.getElementById('zip').value.trim(),
            email: document.getElementById('email').value.trim(),
          };
          const res = await fetch('/api/value', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          result.hidden = false;
          if (!res.ok) throw new Error(data.error || 'Failed');
          price.textContent = data.valuation;
        } catch (err) {
          result.hidden = false;
          error.textContent = err.message || 'Something went wrong';
        } finally {
          submit.disabled = false;
          submit.textContent = 'Get Valuation';
        }
      });

      // VIN scan logic
      const VIN_REGEX = /\b([A-HJ-NPR-Z\d]{17})\b/g; // excludes I, O, Q

      scanVinBtn?.addEventListener('click', () => {
        vinImage.click();
      });

      vinImage?.addEventListener('change', async () => {
        if (!vinImage.files || vinImage.files.length === 0) return;
        const file = vinImage.files[0];
        try {
          scanVinBtn.disabled = true;
          scanVinBtn.textContent = 'Scanning…';
          const dataUrl = await fileToDataUrl(file);
          const { data } = await Tesseract.recognize(dataUrl, 'eng', {
            tessedit_char_whitelist: 'ABCDEFGHJKLMNPRSTUVWXYZ0123456789',
          });
          const text = (data && data.text ? data.text : '').toUpperCase();
          const matches = [...text.matchAll(VIN_REGEX)].map(m => m[1]);
          if (matches.length > 0) {
            vinInput.value = matches[0];
          } else {
            alert('No VIN detected. Try a clearer, closer photo of the VIN label.');
          }
        } catch (e) {
          alert('VIN scan failed: ' + (e && e.message ? e.message : 'unknown error'));
        } finally {
          scanVinBtn.disabled = false;
          scanVinBtn.textContent = 'Scan VIN';
          vinImage.value = '';
        }
      });

      function fileToDataUrl(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }
    </script>
  </body>
  </html>


